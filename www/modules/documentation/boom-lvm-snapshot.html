<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Definitive RHEL9 Workshop (v9.1)</title>
    <meta name="generator" content="Antora 3.1.7">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="../..">Definitive RHEL9 Workshop (v9.1)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html" class=" query-params-link">Default Title</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../overview.html">Workshop Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="webconsole.html">Web Console (cockpit)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="systemd.html">Service Management (systemd)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="firewalld.html">Firewall Management (firewalld)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="nftables.html">Firewall Rules (nf-tables)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ebpf.html">eBPF Tracing (bcc-tools)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="podman.html">Containers Management (podman)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="buildah.html">Containers Dev (buildah)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="image-builder.html">Image Builder (composer-cli)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="virtualization.html">Virtualization (kvm,libvirt)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tlog.html">Session Logging (tlog)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lvm-vdo.html">Data Optimization (lvm,vdo)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="stratis.html">Storage Management (stratis)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="kpatch.html">Kernel Live Patching (kpatch)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="boom-kernel-parms.html">Managing GRUB2 with Boom</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="leapp.html">LEAPP In-Place Upgrades</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Default Title</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Default Title</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../connection.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="file:///Users/jmaltin/Development/RHEL9-Workshop-Showroom/content/modules/ROOT/pages/documentation/boom-lvm-snapshot.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_boom_with_lvm_snapshot"><a class="anchor" href="#_boom_with_lvm_snapshot"></a>Boom (with LVM Snapshot)</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BOOM is a boot manager for Linux systems that support the 'BootLoader Specification' for boot entry configuration. It simplifies the creation of new or modified boot entries: for example, to boot snapshot images of the system created using LVM.</p>
</div>
<div class="paragraph">
<p>BOOM does not modify the existing boot loader configuration, and <strong>only inserts</strong> additional entries. The existing configuration is maintained, and any distribution integration, such as kernel installation and update scripts, continue to function as before.</p>
</div>
<div class="paragraph">
<p>BOOM also has a simple command-line interface (CLI) and API.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="anchor" href="#_getting_started"></a>Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For these exercises, you will be using the host <code>node3</code> as user <code>root</code>.</p>
</div>
<div class="paragraph">
<p>From host <code>bastion</code>, ssh to <code>node3</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ <strong>ssh node3</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>sudo</code> to elevate your privileges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ <strong>sudo -i</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that you are on the right host for these exercises.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># <strong>workshop-boom-checkhost.sh</strong></pre>
</div>
</div>
<div class="paragraph">
<p>You are now ready to proceed with these exercises.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><a class="anchor" href="#_installation"></a>Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following set of instructions will install Boom.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># <strong>dnf install -y boom-boot</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That was easy!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_capacity_to_root_lvm"><a class="anchor" href="#_add_capacity_to_root_lvm"></a>Add Capacity to Root LVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to support LVM snapshots on the root volume, we need to:
  * add some additional storage capacity
  * partition the disk
  * add the partition to the root volume group
  * and finally create logical volume to support the snapshot</p>
</div>
<div class="literalblock">
<div class="content">
<pre>The following command will take care of all of these steps for you.  The individual steps are also outlined below.</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">workshop-boom-snap-addstorage.sh</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Native command(s) to add storage</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>printf "o\nn\np\n\n\n\nw\n" | fdisk /dev/vdb

pvcreate /dev/vdb1

vgextend rhel /dev/vdb1</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Clearing /dev/vdb
    Creating new partition table on /dev/vdb

    Welcome to fdisk (util-linux 2.32.1).
    Changes will remain in memory only, until you decide to write them.
    Be careful before using the write command.

    Device does not contain a recognized partition table.
    Created a new DOS disklabel with disk identifier 0xb8fd7055.

    Command (m for help): Created a new DOS disklabel with disk identifier 0x4e3b8150.

    Command (m for help): Partition type
       p   primary (0 primary, 0 extended, 4 free)
       e   extended (container for logical partitions)
    Select (default p): Partition number (1-4, default 1): First sector (2048-20971519, default 2048): Last sector, +sectors or +size{K,M,G,T,P} (2048-20971519, default 20971519):
    Created a new partition 1 of type 'Linux' and of size 10 GiB.

    Command (m for help): The partition table has been altered.
    Calling ioctl() to re-read partition table.
    Syncing disks.

    Creating physical volume lable on /dev/vdb1
      Physical volume "/dev/vdb1" successfully created.
    Extending volume group 'rhel' with /dev/vdb1
      Volume group "rhel" successfully extended

      Reducing COW size 10.00 GiB down to maximum usable size &lt;8.03 GiB.
      Logical volume "root_snapshot" created.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_some_important_stuff"><a class="anchor" href="#_create_some_important_stuff"></a>Create some Important Stuff</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next set of instructions will create a file and a userID that we will remove and recover as part of this exercise:</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-snap-importantstuff.sh</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Native command(s) to create important file</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>echo "This is an important file!!" &gt; /root/importantfile

useradd importantuser

cat /root/importantfile

grep importantuser /etc/passwd</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Contents of 'importantfile':
    This is an important file!!

    Grepping 'importantuser' from /etc/passwd:
    importantuser:x:1001:1001::/home/importantuser:/bin/bash</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_lv_snapshot_of_root_volume"><a class="anchor" href="#_create_lv_snapshot_of_root_volume"></a>Create LV Snapshot of Root Volume</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have created some important data, it&#8217;s time to create a snapshot of our system.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-snap-mksnap.sh</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Native command(s) to create lvm snapshot</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>lvcreate -s rhel/root -n root_snapshot -L 10G</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us take a quick look at what we just did.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-snap-lvreport.sh</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Native command(s) to report lv status</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>lvs -a -o lv_name,lv_size,lv_attr,segtype,devices

lvs -a -o lv_name,lv_size,lv_attr,origin,snap_percent</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This script uses different options to create 2 different reports.</p>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Local volume reports:
      LV            LSize  Attr       Type   Devices
      root          &lt;8.00g owi-aos--- linear /dev/vda2(256)
      root_snapshot &lt;8.03g swi-a-s--- linear /dev/vdb1(0)
      swap           1.00g -wi-ao---- linear /dev/vda2(0)

      LV            LSize  Attr       Origin Snap%
      root          &lt;8.00g owi-aos---
      root_snapshot &lt;8.03g swi-a-s--- root   0.01
      swap           1.00g -wi-ao----</code></pre>
</div>
</div>
<div class="paragraph">
<p>In your output, note the percentage used in the new snapshot as shown by the 2nd report.</p>
</div>
<div class="paragraph">
<p>Since we have made no real changes to our system, the percentage of the "exception store" used is still very small.  Let&#8217;s change that.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_make_changes_to_system"><a class="anchor" href="#_make_changes_to_system"></a>Make Changes to System</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we are going to remove the “importantfile” file and “importantuser” userID.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">rm -f /root/importantfile
userdel importantuser</pre>
</div>
</div>
<div class="paragraph">
<p>What the heck, let&#8217;s anti up and delete some more stuff.  Who needs documentation anyway!</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">rm -rf /usr/share/man
rm -rf /usr/share/doc
rm -rf /usr/share/GeoIP</pre>
</div>
</div>
<div class="paragraph">
<p>Confirm that our changes were effective</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">cat /root/importantfile

grep -c importantuser /etc/passwd</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
"grep -c" counts how many time the token is matched.  In our case it should be zero
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    cat: /root/importantfile: No such file or directory

    0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Analyze the snapshot data and we see that there is now a measurable difference.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-snap-lvreport.sh</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Local volume reports:
      LV            LSize  Attr       Type   Devices
      root          &lt;8.00g owi-aos--- linear /dev/vda2(256)
      root_snapshot &lt;8.03g swi-a-s--- linear /dev/vdb1(0)
      swap           1.00g -wi-ao---- linear /dev/vda2(0)

      LV            LSize  Attr       Origin Snap%
      root          &lt;8.00g owi-aos---
      root_snapshot &lt;8.03g swi-a-s--- root   0.38
      swap           1.00g -wi-ao----</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s summarize what&#8217;s been done so far:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you added some storage capacity to the root volume</p>
</li>
<li>
<p>you created an "importantfile" and an "importantuser" on your host</p>
</li>
<li>
<p>you created a snapshot of the root volume</p>
</li>
<li>
<p>you then made some changes to the host (deleted a bunch of stuff)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Time to boot our host using the snapshot value, inspect the host to verify our data is there and then finally recover the host.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_boom"><a class="anchor" href="#_boom"></a>BOOM!!!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a boom profile.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-mkprofile.sh</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Native command(s) to create boom profile</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>boom profile create --from-host --uname-pattern el8</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Created profile with os_id e6f881a:
      OS ID: "e6f881ae3f8a2e010375fb840bb4f386b330db6e",
      Name: "Red Hat Enterprise Linux", Short name: "rhel",
      Version: "8.0 (Ootpa)", Version ID: "8.0",
      UTS release pattern: "el8",
      Kernel pattern: "/vmlinuz-%{version}", Initramfs pattern: "/initramfs-%{version}.img",
      Root options (LVM2): "rd.lvm.lv=%{lvm_root_lv}",
      Root options (BTRFS): "rootflags=%{btrfs_subvolume}",
      Options: "root=%{root_device} ro %{root_opts}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the boom profile was created by the previous command.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">boom profile list</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    OsID    Name                     OsVersion
    e6f881a Red Hat Enterprise Linux 8.0 (Ootpa)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now to create a boot entry for grub which utilizes the snapshot as the boot volume.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-snap-mkentry.sh</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Native command(s) to create grub entry</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>boom create --title "root LV snapshot" --rootlv rhel/root_snapshot</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    WARNING - Boom grub2 script missing from '/etc/grub.d'
    WARNING - Boom configuration not found in grub.cfg
    WARNING - Run 'grub2-mkconfig &gt; /boot/grub2/grub.cfg' to enable
    Created entry with boot_id 85e739d:
      title root LV snapshot
      machine-id e988045b45b04b11b84741d6a568861b
      version 4.18.0-67.el8.x86_64
      linux /vmlinuz-4.18.0-67.el8.x86_64
      initrd /initramfs-4.18.0-67.el8.x86_64.img
      options root=/dev/rhel/root_snapshot ro rd.lvm.lv=rhel/root_snapshot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look at currently configured boom-boot entries.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">boom entry list</pre>
</div>
</div>
<div class="paragraph">
<p>Your output should look like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    BootID  Version                  Name                     RootDevice
    85e739d 4.18.0-67.el8.x86_64     Red Hat Enterprise Linux /dev/rhel/root_snapshot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Show details about our boom-boot entry.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">boom entry show 85e739d</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Boot Entry (boot_id=85e739d)
      title root LV snapshot
      machine-id e988045b45b04b11b84741d6a568861b
      version 4.18.0-67.el8.x86_64
      linux /vmlinuz-4.18.0-67.el8.x86_64
      initrd /initramfs-4.18.0-67.el8.x86_64.img
      options root=/dev/rhel/root_snapshot ro rd.lvm.lv=rhel/root_snapshot</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reboot_to_snapshot"><a class="anchor" href="#_reboot_to_snapshot"></a>Reboot to Snapshot</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Bring up the virtual machine console for node3 before proceeding.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before reboot, there are 2 options to invoke the right loader at restart:
  . enter the GRUB menu and select at boot time
  . use grub-set-default to preselect which one to load</p>
</div>
<div class="paragraph">
<p>We are going to opt for preselect since it&#8217;s just easier.  Use the following workshop to inspect the currently configured GRUB menu options.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-grublist.sh</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    0  title="root LV snapshot"
    1  title="Red Hat Enterprise Linux (4.18.0-67.el8.x86_64) 8.0 (Ootpa)"
    2  title="Red Hat Enterprise Linux (0-rescue-e988045b45b04b11b84741d6a568861b) 8.0 (Ootpa)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to reboot to our snapshot, so in this case we use '0'.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">grub2-set-default 0</pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the parameters stuck</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">grub2-editenv list</pre>
</div>
</div>
<div class="paragraph">
<p>Notice that "saved_entry=0", that&#8217;s what we want.</p>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    saved_entry=0
    kernelopts=root=/dev/mapper/rhel-root_snapshot ro crashkernel=auto resume=/dev/mapper/rhel-swap rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet
    boot_success=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will now reset our host and boot the snapshot Logical Volume.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">reboot</pre>
</div>
</div>
<div class="sect2">
<h3 id="_confirm_previous_state_of_host"><a class="anchor" href="#_confirm_previous_state_of_host"></a>Confirm Previous State of Host</h3>
<div class="paragraph">
<p>Once the host is back online, ssh to back to <strong>node3.example.com</strong> and verify that the “importantfile” and “importantuser” exist in the backup snapshot:</p>
</div>
<div class="listingblock">
<div class="title">[root@bastion]#</div>
<div class="content">
<pre class="nowrap">ssh root@node3.example.com</pre>
</div>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">df /</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Filesystem                     1K-blocks    Used Available Use% Mounted on
    /dev/mapper/rhel-root_snapshot   8374272 1321268   7053004  16% /</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s find our data.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">cat /root/importantfile

grep importantuser /etc/passwd

du -sh /usr/share/doc

du -sh /usr/share/GeoIP

man bash</pre>
</div>
</div>
<div class="paragraph">
<p>Wahoo! Man pages are back!  It should be clear that the data removed earlier is still present within the snapshot volume.  Now it&#8217;s time to recover the data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can technically initiate the logical volume merge now, set the grub default back to the normal boot entry, and reboot as merging requires a unmount before anything happens and once it&#8217;s initiated it can work in the background.  But, we are going to utilize the rescue image for extra fun!
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_return_host_to_previous_state"><a class="anchor" href="#_return_host_to_previous_state"></a>Return Host to Previous State</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Bring up the virtual machine console for node3 before proceeding.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will now reboot node3 virtual machine again into rescue mode and return the host to it&#8217;s previous state.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-grublist.sh</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    0  title="root LV snapshot"
    1  title="Red Hat Enterprise Linux (4.18.0-67.el8.x86_64) 8.0 (Ootpa)"
    2  title="Red Hat Enterprise Linux (0-rescue-e988045b45b04b11b84741d6a568861b) 8.0 (Ootpa)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to reboot to recuse mode, so in this case we use '2'.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">grub2-set-default 2</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">reboot</pre>
</div>
</div>
<div class="paragraph">
<p>Once the host is back online, ssh to back to <strong>node3.example.com</strong>.</p>
</div>
<div class="listingblock">
<div class="title">[root@bastion]#</div>
<div class="content">
<pre class="nowrap">ssh root@node3.example.com</pre>
</div>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">df /

cat  /proc/cmdline</pre>
</div>
</div>
<div class="paragraph">
<p>The output shows that we are no longer mounted to the snapshot volume, and we ARE using the rescue kernel image.</p>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Filesystem            1K-blocks    Used Available Use% Mounted on
    /dev/mapper/rhel-root   8374272 1230660   7143612  15% /</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">.[root@node3 ~]# cat /proc/cmdline
BOOT_IMAGE=(hd0,msdos1)/vmlinuz-0-rescue-e988045b45b04b11b84741d6a568861b root=/dev/mapper/rhel-root ro crashkernel=auto resume=/dev/mapper/rhel-swap rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet</pre>
</div>
</div>
<div class="paragraph">
<p>Time return the host back to it&#8217;s previous state.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">lvconvert --merge /dev/rhel/root_snapshot</pre>
</div>
</div>
<div class="paragraph">
<p>As pointed out earlier, the "merge" will being the next time the root volume is mounted.  This output merely confirms this.</p>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    Delaying merge since origin is open.
    Merging of snapshot rhel/root_snapshot will occur on next activation of rhel/root.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last few steps and we will be done.</p>
</div>
<div class="paragraph">
<p>Set grub to boot default OS again.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-grublist.sh</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    0  title="root LV snapshot"
    1  title="Red Hat Enterprise Linux (4.18.0-67.el8.x86_64) 8.0 (Ootpa)"
    2  title="Red Hat Enterprise Linux (0-rescue-e988045b45b04b11b84741d6a568861b) 8.0 (Ootpa)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time we want entry '1'.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">grub2-set-default 1</pre>
</div>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">reboot</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_confirm_system_restored"><a class="anchor" href="#_confirm_system_restored"></a>Confirm System Restored</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have now returned the host to it&#8217;s previous state (ie: the moment we created the snapshot with boom). Let&#8217;s make sure everything is where we expect.</p>
</div>
<div class="listingblock">
<div class="title">[root@bastion ~]#</div>
<div class="content">
<pre class="nowrap">ssh root@node3.example.com</pre>
</div>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">cat /root/importantfile

grep importantuser /etc/passwd</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    This is an important file!!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last piece of information.  Since the "snapshot" was merged back into it&#8217;s "origin", the snapshot itself is now gone.  You can confirm this by running "lvs" and noting that the root_snapshot is missing.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">lvs</pre>
</div>
</div>
<div class="paragraph">
<p>Thus our boom-boot entry points to a non-existent volume.  Here are the final commands to clean everything up.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">boom entry list</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    BootID  Version                  Name                     RootDevice
    85e739d 4.18.0-67.el8.x86_64     Red Hat Enterprise Linux /dev/rhel/root_snapshot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make note of the BootID and use it in the next command.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">boom entry delete 85e739d</pre>
</div>
</div>
<div class="paragraph">
<p>Double check the grub configuration.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">workshop-boom-grublist.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the snapshot entry has been removed.</p>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    0  title="Red Hat Enterprise Linux (4.18.0-67.el8.x86_64) 8.0 (Ootpa)"
    1  title="Red Hat Enterprise Linux (0-rescue-e988045b45b04b11b84741d6a568861b) 8.0 (Ootpa)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure grub is configured to boot the entry.</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">grub2-editenv list</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Command Output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">    saved_entry=1
    kernelopts=root=/dev/mapper/rhel-root ro crashkernel=auto resume=/dev/mapper/rhel-swap rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet
    boot_success=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whoops!  That&#8217;s not right</p>
</div>
<div class="listingblock">
<div class="title">[root@node3]#</div>
<div class="content">
<pre class="nowrap">grub2-set-default 0</pre>
</div>
</div>
<div class="paragraph">
<p>Wahoo! You are done.  If you have any questions, please ask.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_additional_resources"><a class="anchor" href="#_additional_resources"></a>Additional Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://systemd.io/BOOT_LOADER_SPECIFICATION.html">Boot Loader Specification</a></p>
</li>
</ul>
</div>
<h2 id="_end_of_unit" class="discrete">End of Unit</h2>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
